<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<title>Angular.js nvd3.js Line Chart Directive</title>
<meta http-equiv="content-type" content="text/html; charset=UTF8">
<script src="js/angular.js"></script>
<script src="js/d3.js"></script>
<script src="js/nv.d3.js"></script>
<script src="../dist/angularjs-nvd3-directives.js"></script>
<link rel="stylesheet" href="stylesheets/nv.d3.css"/>


<script>
var app = angular.module("nvd3TestApp", ['nvd3ChartDirectives']);

app.controller('ExampleCtrl', function($scope,  $http,  $log, $interval){
		console.log(" Formulario SNMP Controller reporting for duty.");
		$scope.submission = false;
		$scope.formData = {};
		$scope.dataCounter = 0;
		$scope.keys = [];
		$scope.graphData = [];
		$scope.initial_measured = false;
$scope.measured_time = 0;
		$scope.measured_value = 0;

		$scope.calculateKeys = function () {
		$scope.keys.push("foo");
		$scope.keys.push("bar");
		$scope.graphData.push({ "key": "foo", "values": [] });
		$scope.graphData.push({ "key": "bar", "values": [] });
		};

		$scope.dataCounter = 0;

		$scope.graphs = [
		{
			"name": "Foos Only",
				"height": 300,
				"series": [ { label: 'Foo', key: 'foo', enabled: true } ]
		},
		{
			"name": "Bars Only",
			"height": 300,
			"series": [ { label: 'Bar', key: 'bar', enabled: true } ]
		}
		];

		var param = function(data) {
			var returnString = '';
			for (d in data){
				if (data.hasOwnProperty(d))
					returnString += d + '=' + data[d] + '&';
			}
			// Remove last ampersand and return
			return returnString.slice( 0, returnString.length - 1 );
		};

		$scope.fetchSNMP = function() {
			$http({
method : 'POST',
url : 'php/snmpv2.php',
data : param($scope.formData), // pass in data as strings
headers : { 'Content-Type': 'application/x-www-form-urlencoded' } // set the headers so angular passing info as form data (not request payload)
})
.success(function(data) {
		if (!data.success) {
		// if not successful, bind errors to error variables
		$scope.error_ip_address = data.errors.ip_address;
		$scope.error_snmp_key = data.errors.snmp_key;
		$scope.error_snmp_mib = data.errors.snmp_mib;
		$scope.submissionMessage = data.messageError;
		$scope.submission = true; //shows the error message
		} else {
		// if successful, bind success message to message

		if ($scope.keys.length === 0) {
		$scope.calculateKeys();
		}
		if ($scope.initial_measured == true) {
		$scope.measured_time = angular.fromJson(data.time);;
		}
		
		$scope.data = data;
		var tempo = angular.fromJson(data.time);
		var snmp_packets = angular.fromJson (data.snmp_packets);
		console.log(" Tempo: "+tempo + " snmp packets: " + snmp_packets );
		var timeDiff = tempo - $scope.measured_time;
		$scope.dataCounter = $scope.dataCounter + timeDiff;
		$scope.measured_time = tempo;
		console.log('setInterval counter is now at : ' + $scope.dataCounter);
		$scope.graphData[0].values.push([$scope.dataCounter, snmp_packets])
		$scope.submission_result = data; // Show result from server in our <pre></pre> element  
		$scope.submissionMessage = data.messageSuccess;
		$scope.submission = true; //shows the success message
		}
});
};

var stop;

$scope.clear = function(){
	$scope.dataCounter = 0;
	$scope.keys = [];
	$scope.graphData = [];

	$scope.calculateKeys();
};

$scope.start = function() {
	// Don't start again
	if ( angular.isDefined(stop) ) return;
	$scope.fetchSNMP();
	if ( $scope.submission == true ){
		stop = $interval(function() {
				$scope.fetchSNMP();
				}, 1000);
	}	
};

$scope.stop = function() {
	if (angular.isDefined(stop)) {
		$interval.cancel(stop);
		stop = undefined;
	}
};

$scope.$on('$destroy', function() {
		// Make sure that the interval is destroyed too
		$scope.stop();
		});

});

app.filter('graphDataFilter', function () {
		return function (data, series) {
		var r = [];

		for (var s = 0; s < series.length; s++) {
		for (var i = 0; i < data.length; i++) {
		if (data[i].key == series[s].key) {
		r.push({ key: series[s].label, values: data[i].values, disabled: !series[s].enabled });
		}
		}
		}

		return r;
		};
		})

app.directive('extendedChart', function () {
		return {
restrict: 'E',
link: function ($scope) {
$scope.d3Call = function (data, chart) {
var svg = d3.select('#' + $scope.id + ' svg').datum(data);

var path = svg.selectAll('path');

path.data(data)
.transition()
.ease("linear")
.duration(300);

return svg.transition()
.duration(300)
.call(chart);
};
}
};
})

</script>

</head>
<body ng-app='nvd3TestApp'>

<div ng-controller="ExampleCtrl">
<button ng-click="start()">Start Fetching</button>&nbsp;&nbsp;<button ng-click="stop()">Stop Fetching</button>&nbsp;&nbsp;<button ng-click="clear()">Clear Data</button>

<br/>

<label for="name">ipAddress</label>
<input type="text" name="ip_address" ng-model="formData.ip_address" ng-class="{'error' : error_ip_address}">
<label for="email">SNMP Key</label>
<input type="text" name="snmp_key" ng-model="formData.snmp_key" ng-class="{'error' : error_snmp_mib}">
<label for="message">SNMP MIB</label>
<input type="text" name="snmp_mib" value="1.1" ng-model="formData.snmp_mib" ng-class="{'error' : error_snmp_mib}">
<label for="message">SNMP TIME TRACKING MIB</label>
<input type="text" name="snmp_mib_time" value="SNMPv2-MIB::sysUpTime.0" ng-model="formData.snmp_mib_time" ng-class="{'error' : error_snmp_mib_time}">
<div ng-class="{'submissionMessage' : submission}" ng-bind="submissionMessage"></div>
<pre ng-model="result">
{{submission_result}}
</pre>


<div ng-repeat="graph in graphs">
<nvd3-line-chart
data="graphData"
filtername="'graphDataFilter'"
filtervalue="graph.series"
id="graph_line_{{$index}}"
height="{{graph.height}}"
width="800"
showxaxis="true"
showyaxis="true"
forcey="[0]"
tooltips="true"
interactive="true"
margin="{left:50,top:50,bottom:50,right:50}"
showlegend="true"
legendupdatestate="false"
objectequality="true"
nodata="Fetching statistics...">
<extended-chart><svg></svg></extended-chart>
</nvd3-line-chart>
</div>


<div ng-controller="ExampleCtrl">
    <nvd3-sparkline-chart
            data="exampleData"
            id="exampleId"
            x="xFunction()"
            y="yFunction()"
            rightalignValue="true">
        <svg></svg>
    </nvd3-sparkline-chart>

</div>
</div>
</body>
</html>
